from fastapi import APIRouter, Request
from app.services.mongo_db import get_recent_messages, save_user, save_message
from app.services.gemini_api import chat_with_gpt, analyze_crop_image, get_user_session_info
from app.services.whatsapp_api import send_whatsapp_message
from app.services.generate_questions import generate_Questions
from app.services.follow_up_handler import follow_up_handler
from app.utils.helper import extract_phone_number, format_whatsapp_message, download_twilio_media
import base64

router = APIRouter()

def check_direct_call_request(message: str) -> bool:
    """
    Check if user is directly requesting a call without any prior voice bot prompt.
    Returns True if user wants to initiate a voice call.
    """
    message_lower = message.lower().strip()
    
    # English call request patterns
    english_patterns = [
        'call me', 'call kar', 'call karo', 'call please', 
        'phone call', 'voice call', 'baat karna chahiye', 
        'call back', 'ring me', 'phone karo', 'call now'
    ]
    
    # Hindi call request patterns  
    hindi_patterns = [
        '‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç', '‡§ï‡•â‡§≤ ‡§ï‡§∞', '‡§ï‡•â‡§≤ ‡§ï‡§∞‡•ã', '‡§´‡•ã‡§® ‡§ï‡§∞‡•á‡§Ç', 
        '‡§´‡•ã‡§® ‡§ï‡§∞‡•ã', '‡§¨‡§æ‡§§ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è', '‡§¨‡§æ‡§§ ‡§ï‡§∞‡§®‡§æ ‡§π‡•à',
        '‡§Ü‡§µ‡§æ‡§ú‡§º ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§§', 'voice ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§§', '‡§¨‡•ã‡§≤ ‡§ï‡§∞ ‡§¨‡§§‡§æ‡§è‡§Ç',
        '‡§ï‡•â‡§≤ ‡§™‡§∞ ‡§¨‡§æ‡§§', '‡§´‡•ã‡§® ‡§™‡§∞ ‡§¨‡§æ‡§§', 'call ‡§ï‡§∞‡•á‡§Ç', 'call ‡§ï‡§∞‡•ã'
    ]
    
    # Check for direct call patterns
    for pattern in english_patterns + hindi_patterns:
        if pattern in message_lower:
            return True
    
    return False

def check_voice_bot_request(user_id: str, current_message: str) -> bool:
    """
    Check if user replied 'yes' to the voice bot question.
    Returns True if the last bot message was voice_bot_msg and user replied yes.
    """
    # Normalize user response
    user_response = current_message.lower().strip()

    # Check for positive responses in English and Hindi
    positive_responses = ['yes', 'y', '‡§π‡§æ‡§Å', '‡§π‡§æ‡§Ç', 'han', 'haan', 'ok', 'okay']

    if user_response not in positive_responses:
        return False

    # Get last 5 messages to check conversation context (increased for better detection)
    recent_messages = get_recent_messages(user_id, limit=5)

    if len(recent_messages) < 2:
        return False

    # Look for voice bot question in recent messages
    for msg in reversed(recent_messages):
        if (msg.get('is_bot', False) and 
            'üéôÔ∏è' in msg.get('message', '') and 
            'KHETI AI EXPERT' in msg.get('message', '')):
            return True

    return False

async def initiate_direct_voice_call(user_id: str, phone_number: str, user_message: str) -> bool:
    """
    Initiate voice call immediately when user directly requests it.
    """
    try:
        # Send immediate acknowledgment
        ack_message = (
            "üìû **‡§ï‡•â‡§≤ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à!** (Call starting!)\n\n"
            "üéôÔ∏è **‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•â‡§≤ 30 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§Ü‡§è‡§ó‡•Ä:**\n"
            "‚Ä¢ ‡§´‡•ã‡§® ‡§ï‡•Ä ‡§∞‡§ø‡§Ç‡§ó ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç\n"
            "‚Ä¢ ‡§Ö‡§™‡§®‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¨‡§§‡§æ‡§è‡§Ç\n"
            "‚Ä¢ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ø‡§æ English ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç\n\n"
            "‚è≥ **‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...**"
        )
        
        send_whatsapp_message(phone_number, ack_message)
        save_message(user_id, ack_message, "", True, "")
        
        # Format phone number for API
        formatted_phone = f"0{phone_number.replace('+91', '').replace('+', '')}"
        
        # Prepare API call data with enhanced system message
        api_url = "http://115.112.107.166:8081/api/make_call"
        
        # Get recent conversation context for better voice bot interaction
        recent_messages = get_recent_messages(user_id, limit=10)
        conversation_context = ""
        
        for msg in recent_messages[-5:]:  # Last 5 messages for context
            if msg.get('message'):
                role = "User" if not msg.get('is_bot', False) else "Bot"
                conversation_context += f"{role}: {msg.get('message', '')[:100]}...\n"
        
        system_message = f"""You are KHETI AI EXPERT, an advanced agricultural assistant voice bot for Indian farmers. You speak Hindi and English fluently.

FARMER CONTEXT:
- Phone: {phone_number}
- Direct Call Request: "{user_message}"
- Recent Context: {conversation_context}

YOUR ROLE:
üåæ Expert agricultural consultant specializing in Indian crops
üéØ Friendly, patient, and solution-focused
üì± Connected to WhatsApp for follow-up support

CONVERSATION APPROACH:
1. Warm greeting + acknowledge their call request
2. Ask about their specific crop problem
3. Gather key details: crop type, symptoms, field size, location
4. Provide immediate actionable advice
5. Mention WhatsApp follow-up with detailed solutions

REMEMBER:
- Be conversational and empathetic
- Ask one question at a time
- Give practical, local solutions
- Use Hindi-English mix as comfortable for farmers
- Keep responses under 30 seconds each
- Mention WhatsApp support for detailed treatment plans

Start with: "Namaste! Main aapka KHETI AI EXPERT hun. Aapne call ki request ki thi - main yahan hun aapki madad ke liye!"
"""

        call_data = {
            "phone_number": formatted_phone,
            "system_message": system_message
        }
        
        print(f"[DIRECT_CALL] Initiating call to {formatted_phone}")
        
        # Make API call
        import requests
        response = requests.post(api_url, json=call_data, timeout=10)
        
        if response.status_code == 200:
            result = response.json()
            print(f"[DIRECT_CALL] API Response: {result}")
            
            success_message = (
                "‚úÖ **‡§ï‡•â‡§≤ Successfully ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•Å‡§à!**\n"
                "üìû ‡§Ü‡§™‡§ï‡§æ ‡§´‡•ã‡§® ‡§¨‡§ú‡•á‡§ó‡§æ\n"
                "ü§ñ KHETI AI EXPERT ‡§∏‡•á ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç\n\n"
                "üí° **‡§ï‡•â‡§≤ ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§Ü‡§™‡§ï‡•ã ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ:**\n"
                "‚Ä¢ Detailed treatment plan\n" 
                "‚Ä¢ Product recommendations\n"
                "‚Ä¢ Step-by-step solutions"
            )
            
            send_whatsapp_message(phone_number, success_message)
            save_message(user_id, success_message, "", True, "")
            
            return True
        else:
            raise Exception(f"API call failed: {response.status_code}")
            
    except Exception as e:
        print(f"[DIRECT_CALL] Error: {str(e)}")
        
        # Send error message
        error_message = (
            "‚ùå **‡§ï‡•â‡§≤ ‡§Æ‡•á‡§Ç ‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ**\n\n"
            "üîÑ **‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï ‡§§‡§∞‡•Ä‡§ï‡•á:**\n"
            "‚Ä¢ 5 ‡§Æ‡§ø‡§®‡§ü ‡§¨‡§æ‡§¶ 'call ‡§ï‡§∞‡•á‡§Ç' ‡§≤‡§ø‡§ñ ‡§ï‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç\n"
            "‚Ä¢ ‡§Ö‡§™‡§®‡•Ä ‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§≠‡•á‡§ú‡•á‡§Ç\n"
            "‚Ä¢ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ‡•á‡§Ç\n\n"
            "üìû **Direct Call**: +91 85188 00080"
        )
        
        send_whatsapp_message(phone_number, error_message)
        save_message(user_id, error_message, "", True, "")
        
        return False

async def test_voice_bot_api(phone_number: str):
    """
    Test function to check if voice bot API is working
    Call this function directly to test the API
    """
    import requests
    import asyncio
    
    # Format phone number (add prefix 0 as required by API)
    formatted_phone = f"0{phone_number.replace('+91', '').replace('+', '')}"
    
    # API payload for testing
    payload = {
        "Voicechat_id": "yBDtN5156Agk",
        "ai_agent_ext": 416102,
        "customer_no": formatted_phone,
        "text": "This is a test call from WhatsApp bot. Testing voice bot functionality.",
        "system_msg": "You are a test voice bot. Keep the conversation short and confirm that the call is working.",
        "connect_ws_after_answer": False,
        "timezone": "Asia/Kolkata"
    }
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": "Bearer 9dd1de37f1bf4ba5a1367760a6539a9b"  # ‚ö†Ô∏è REPLACE THIS
    }
    
    try:
        print(f"üß™ Testing Voice Bot API for: {formatted_phone}")
        print(f"üìû Original phone: {phone_number}")
        print(f"üìã Payload: {payload}")
        
        response = requests.post(
            "https://api.ivrsolutions.in/api/dial_by_voicebot",
            json=payload,
            headers=headers,
            timeout=30
        )
        
        print(f"‚úÖ Status: {response.status_code}")
        print(f"üìÑ Response: {response.text}")
        
        return response.status_code == 200
        
    except Exception as e:
        print(f"‚ùå Test failed: {str(e)}")
        return False

async def handle_voice_bot_call(user_id: str, phone_number: str, crop_type: str, message: str):
    """
    Handle voice bot API call if user agreed to voice bot assistance.
    Only calls API if check_voice_bot_request returns True.
    """
    import requests
    import asyncio
    
    # Check if this is a positive response to voice bot question
    if not check_voice_bot_request(user_id, message):
        return False
    
    try:
        # Save user's positive response first
        save_message(user_id, message, "", False, crop_type)
        
        # Prepare API call data
        api_url = "https://api.ivrsolutions.in/api/dial_by_voicebot"
        
        # Format phone number (add prefix 0 as required by API)
        formatted_phone = f"0{phone_number.replace('+91', '').replace('+', '')}"
        print(f"Formatted phone number for API: {formatted_phone}")
        
        # Get recent conversation context for the system message
        recent_messages = get_recent_messages(user_id, limit=5)
        conversation_context = ""
        
        for msg in recent_messages:
            if not msg.get('is_bot', False) and msg.get('message', '').strip():
                conversation_context = msg.get('message', '')
                break
        
        # Generate diagnostic questions based on conversation history
        diagnostic_questions = await generate_Questions(user_id)
        questions_text = "\n".join([f"{i+1}. {q}" for i, q in enumerate(diagnostic_questions)])
        
        # Prepare system message with crop context and generated questions
        system_message = f"""You are AgriBot, an AI agricultural assistant specializing in crop disease diagnosis and product recommendations.

CONVERSATION CONTEXT:
Crop type: {crop_type if crop_type else 'Not specified'}
Recent farmer queries: {conversation_context[:800] if conversation_context else 'Image analysis completed'}

DIAGNOSTIC QUESTIONS TO ASK:
{questions_text}

YOUR ROLE & INSTRUCTIONS:
1. First, greet the farmer warmly in Hindi
2. Introduce yourself as AgriBot designed to help with crop disease diagnosis
3. Start asking the diagnostic questions one by one to understand their crop problem better
4. Based on their answers, provide specific crop disease diagnosis and treatment recommendations
5. If they ask for product recommendations, look up current agricultural products and suggest specific brands/medicines available in India
6. Speak primarily in Hindi with English technical terms where necessary (‡§ú‡•à‡§∏‡•á fertilizer, pesticide, fungicide etc.)
7. Be conversational, empathetic, and practical in your approach
8. Focus on actionable solutions and product recommendations

COMMUNICATION STYLE:
- Use Hindi as primary language with English technical terms
- Be warm and understanding of farmer's concerns  
- Ask follow-up questions if needed for better diagnosis
- Provide specific product names and application methods
- Keep responses concise but comprehensive

Start by greeting them and then systematically work through the diagnostic questions to help them effectively."""
        
        # API payload
        payload = {
            "Voicechat_id": "yBDtN5156Agk",  # Replace with your actual voicechat ID
            "ai_agent_ext": 416102,  # Replace with your AI agent extension
            "customer_no": formatted_phone,
            "text": "Namaste! Main aapka Krishi Sahayak Voice-Bot hun. Aap apni fasal ki samasya bata sakte hain. Hello! I'm your Agricultural Assistant Voice-Bot. You can tell me about your crop problems.",
            "system_msg": system_message,
        }
        
        # API headers
        headers = {
            "Content-Type": "application/json",
            "Authorization": "Bearer 9dd1de37f1bf4ba5a1367760a6539a9b"
        }
        
        # Debug logging
        print(f"=== VOICE BOT API CALL DEBUG ===")
        print(f"API URL: {api_url}")
        print(f"Original phone: {phone_number}")
        print(f"Formatted phone: {formatted_phone}")
        print(f"Payload: {payload}")
        print(f"Headers: {headers}")
        print("================================")
        
        # Make the API call
        print(f"Initiating voice bot call for {phone_number} (formatted: {formatted_phone})")
        
        # Use asyncio to make the request non-blocking
        loop = asyncio.get_event_loop()
        response = await loop.run_in_executor(
            None, 
            lambda: requests.post(api_url, json=payload, headers=headers, timeout=30)
        )
        
        print(f"=== API RESPONSE DEBUG ===")
        print(f"Status Code: {response.status_code}")
        print(f"Response Headers: {dict(response.headers)}")
        print(f"Response Text: {response.text}")
        print("===========================")
        
        # Handle API response
        if response.status_code == 200:
            success_msg = (
                "üìû ‡§ï‡•â‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§ó‡§à!\n"
                "üì≤ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡•ã‡§® ‡§â‡§†‡§æ‡§è‡§Ç‡•§"
            )
            send_whatsapp_message(phone_number, success_msg)
            save_message(user_id, success_msg, "", True, crop_type)
            
            return True
            
        else:
            # Handle API errors
            error_response = response.json() if response.headers.get('content-type') == 'application/json' else {}
            error_message = error_response.get('message', 'Unknown error occurred')
            
            if response.status_code == 400:
                error_msg = f"‚ùå Call parameters mein problem: {error_message}"
            elif response.status_code == 405:
                error_msg = f"‚ùå API access denied: {error_message}"
            elif response.status_code == 500:
                error_msg = f"‚ùå Server problem: {error_message}"
            else:
                error_msg = f"‚ùå Voice-Bot call mein problem (Code: {response.status_code}): {error_message}"
            
            send_whatsapp_message(phone_number, error_msg)
            save_message(user_id, error_msg, "", True, crop_type)
            
            # Offer alternative support
            fallback_msg = (
                "üîÑ Voice-Bot call nahi ho saka. Koi baat nahi!\n"
                "Aap yahan WhatsApp par apni problem puch sakte hain.\n"
                "Main text mein bhi madad kar sakta hun.\n\n"
                "Voice-Bot call failed. No worries!\n"
                "You can ask your questions here on WhatsApp.\n"
                "I can help you via text as well."
            )
            send_whatsapp_message(phone_number, fallback_msg)
            save_message(user_id, fallback_msg, "", True, crop_type)
            
            return False
            
    except requests.exceptions.Timeout:
        timeout_msg = "‚ùå Voice-Bot service mein delay. Thodi der baad try kariye."
        send_whatsapp_message(phone_number, timeout_msg)
        save_message(user_id, timeout_msg, "", True, crop_type)
        return False
        
    except requests.exceptions.RequestException as e:
        network_msg = f"‚ùå Network problem: {str(e)[:100]}"
        send_whatsapp_message(phone_number, network_msg)
        save_message(user_id, network_msg, "", True, crop_type)
        return False
        
    except Exception as e:
        error_msg = f"‚ùå Voice-Bot call mein technical problem: {str(e)[:100]}"
        send_whatsapp_message(phone_number, error_msg)
        save_message(user_id, error_msg, "", True, crop_type)
        print(f"Voice bot API error for {phone_number}: {str(e)}")
        return False

async def get_treatment_progress(user_id: str, phone_number: str) -> str:
    """
    Get treatment progress and provide guidance based on conversation history.
    """
    try:
        # Get recent messages to find voice call summaries and treatments
        recent_messages = get_recent_messages(user_id, limit=20)
        
        voice_call_summaries = []
        treatment_messages = []
        last_analysis = None
        
        for msg in recent_messages:
            message_text = msg.get('message', '')
            crop_type = msg.get('crop_type', '')
            
            if crop_type == 'voice_call_summary':
                voice_call_summaries.append({
                    'message': message_text,
                    'timestamp': msg.get('timestamp', ''),
                    'date': msg.get('timestamp', '')[:10] if msg.get('timestamp') else 'Unknown'
                })
            elif '‡§â‡§™‡§ö‡§æ‡§∞' in message_text or 'treatment' in message_text.lower():
                treatment_messages.append(message_text[:200])
            elif 'Analysis Report' in message_text or '‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§®' in message_text:
                last_analysis = message_text[:300]
        
        if voice_call_summaries:
            latest_call = voice_call_summaries[0]  # Most recent
            progress_msg = f"""üìä **‡§Ü‡§™‡§ï‡§æ Treatment Progress Report**

üéôÔ∏è **Last Voice Call**: {latest_call['date']}
üìù **Total Consultations**: {len(voice_call_summaries)} voice calls + {len(treatment_messages)} text treatments

üìã **Progress Check ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§§‡§æ‡§è‡§Ç**:
‚Ä¢ ‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•à‡§∏‡•Ä ‡§π‡•à? (‡§¨‡•á‡§π‡§§‡§∞/‡§µ‡•à‡§∏‡•Ä ‡§π‡•Ä/‡§î‡§∞ ‡§ñ‡§∞‡§æ‡§¨)
‚Ä¢ ‡§¶‡•Ä ‡§ó‡§à ‡§¶‡§µ‡§æ‡§á‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ ‡§ï‡§ø‡§Ø‡§æ ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç?
‚Ä¢ ‡§ï‡•ã‡§à ‡§®‡§è ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§¶‡§ø‡§ñ‡•á ‡§π‡•à‡§Ç ‡§ï‡•ç‡§Ø‡§æ?
‚Ä¢ ‡§Ö‡§¨ ‡§§‡§ï ‡§ï‡§ø‡§§‡§®‡§æ ‡§™‡•à‡§∏‡§æ ‡§ñ‡§∞‡•ç‡§ö ‡§π‡•Å‡§Ü?

üîç **Next Steps ‡§ï‡•á ‡§≤‡§ø‡§è**:
‚Ä¢ Current photos ‡§≠‡•á‡§ú‡•á‡§Ç updated analysis ‡§ï‡•á ‡§≤‡§ø‡§è
‚Ä¢ 'call ‡§ï‡§∞‡•á‡§Ç' ‡§≤‡§ø‡§ñ‡•á‡§Ç expert ‡§∏‡•á detailed ‡§¨‡§æ‡§§ ‡§ï‡•á ‡§≤‡§ø‡§è
‚Ä¢ Specific problems ‡§π‡•ã‡§Ç ‡§§‡•ã directly ‡§≤‡§ø‡§ñ‡•á‡§Ç

üí° **Tip**: Regular updates ‡§¶‡•á‡§§‡•á ‡§∞‡§π‡§®‡•á ‡§∏‡•á ‡§¨‡•á‡§π‡§§‡§∞ results ‡§Æ‡§ø‡§≤‡§§‡•á ‡§π‡•à‡§Ç!

üìû **Urgent Help**: +91 85188 00080"""
        
        elif last_analysis:
            progress_msg = f"""üìä **Treatment Follow-up Required**

üìù **‡§Ü‡§™‡§ï‡§æ ‡§™‡§ø‡§õ‡§≤‡§æ Analysis**: {last_analysis}...

üîÑ **Progress Update ‡§ï‡•á ‡§≤‡§ø‡§è**:
‚Ä¢ ‡§Ö‡§™‡§®‡•Ä ‡§´‡§∏‡§≤ ‡§ï‡•Ä current photos ‡§≠‡•á‡§ú‡•á‡§Ç
‚Ä¢ Treatment ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§ï‡•ç‡§Ø‡§æ changes ‡§¶‡§ø‡§ñ‡•á ‡§π‡•à‡§Ç?
‚Ä¢ 'call ‡§ï‡§∞‡•á‡§Ç' ‡§≤‡§ø‡§ñ‡§ï‡§∞ detailed discussion ‡§ï‡§∞‡•á‡§Ç

üì± **Quick Actions**:
‚Ä¢ '‡§â‡§™‡§ö‡§æ‡§∞' - step-by-step treatment guide
‚Ä¢ '‡§¶‡§µ‡§æ' - medicine recommendations  
‚Ä¢ 'help' - immediate assistance"""
        
        else:
            progress_msg = f"""üìä **Progress Tracking ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç**

üí¨ **‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à treatment record ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ**

üöÄ **‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è**:
‚Ä¢ ‡§Ö‡§™‡§®‡•Ä ‡§´‡§∏‡§≤ ‡§ï‡•Ä problem ‡§ï‡•Ä photos ‡§≠‡•á‡§ú‡•á‡§Ç
‚Ä¢ 'call ‡§ï‡§∞‡•á‡§Ç' ‡§≤‡§ø‡§ñ‡§ï‡§∞ voice consultation ‡§≤‡•á‡§Ç
‚Ä¢ ‡§Ö‡§™‡§®‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ text ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ‡•á‡§Ç

üìà **Progress tracking benefits**:
‚Ä¢ Treatment effectiveness monitor ‡§ï‡§∞‡§®‡§æ
‚Ä¢ Cost ‡§î‡§∞ time savings
‚Ä¢ Better results ‡§ï‡•á ‡§≤‡§ø‡§è adjustments

üìû **Expert Consultation**: +91 85188 00080"""
        
        return progress_msg
        
    except Exception as e:
        print(f"[PROGRESS] Error getting progress for {user_id}: {str(e)}")
        return f"""üìä **Progress Check**

‚ùå Technical issue in fetching your treatment history.

üîÑ **Please try**:
‚Ä¢ Send fresh crop photos for new analysis
‚Ä¢ Type 'call ‡§ï‡§∞‡•á‡§Ç' for voice consultation
‚Ä¢ Write your current problem in text

üìû **Direct Help**: +91 85188 00080"""

async def send_post_call_summary(user_id: str, phone_number: str, transcript_data: dict):
    """
    Send intelligent summary and solutions after voice call completion.
    """
    try:
        from datetime import datetime
        
        # Extract conversation from transcript
        conversation = transcript_data.get('call_conversation', [])
        call_duration = int(transcript_data.get('call_duration', 0))
        
        if not conversation:
            return False
        
        # Parse conversation if it's a JSON string
        if isinstance(conversation, str):
            import json
            try:
                conversation = json.loads(conversation)
            except json.JSONDecodeError:
                print("[POST_CALL] Error parsing conversation JSON")
                return False
        
        # Prepare conversation text for AI analysis
        conversation_text = ""
        user_messages = []
        bot_messages = []
        
        for msg in conversation:
            role = msg.get('role', '')
            content = msg.get('content', '').strip()
            
            if content and content not in ['noise', '<noise>', '']:
                if role == 'user':
                    conversation_text += f"‡§ï‡§ø‡§∏‡§æ‡§®: {content}\n"
                    user_messages.append(content)
                elif role == 'assistant':
                    conversation_text += f"‡§¨‡•â‡§ü: {content}\n"
                    bot_messages.append(content)
        
        if not user_messages:
            print("[POST_CALL] No valid user messages found")
            return False
        
        # Generate AI-powered summary and solutions
        summary_prompt = f"""
‡§Ü‡§™ ‡§è‡§ï expert agricultural consultant ‡§π‡•à‡§Ç‡•§ ‡§®‡•Ä‡§ö‡•á ‡§¶‡•Ä ‡§ó‡§à voice conversation ‡§ï‡§æ comprehensive analysis ‡§ï‡§∞‡§ï‡•á practical solution ‡§¶‡•á‡§Ç‡•§

VOICE CONVERSATION:
{conversation_text}

CALL DETAILS:
- ‡§Ö‡§µ‡§ß‡§ø: {call_duration} ‡§∏‡•á‡§ï‡§Ç‡§°
- ‡§∏‡§Ç‡§¶‡•á‡§∂‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: {len(conversation)}
- ‡§ï‡§ø‡§∏‡§æ‡§® ‡§ï‡•á ‡§∏‡§µ‡§æ‡§≤: {len(user_messages)}

‡§ï‡•É‡§™‡§Ø‡§æ ‡§á‡§∏ format ‡§Æ‡•á‡§Ç structured response ‡§¶‡•á‡§Ç:

## üîç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ (Problem Summary):
[2-3 lines ‡§Æ‡•á‡§Ç ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§¨‡§§‡§æ‡§è‡§Ç - ‡§´‡§∏‡§≤, disease, ‡§ó‡§Ç‡§≠‡•Ä‡§∞‡§§‡§æ]

## üí° ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡§æ‡§§‡•á‡§Ç (Key Discussion Points):
‚Ä¢ ‡§™‡§π‡§≤‡•Ä ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡§æ‡§§
‚Ä¢ ‡§¶‡•Ç‡§∏‡§∞‡•Ä ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡§æ‡§§  
‚Ä¢ ‡§§‡•Ä‡§∏‡§∞‡•Ä ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡§æ‡§§

## üåø ‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§® (Immediate Solutions):

### ‡§ú‡•à‡§µ‡§ø‡§ï ‡§â‡§™‡§ö‡§æ‡§∞ (Organic Treatment):
‚Ä¢ **‡§®‡•Ä‡§Æ ‡§§‡•á‡§≤**: 15ml/‡§≤‡•Ä‡§ü‡§∞ ‡§™‡§æ‡§®‡•Ä, ‡§∂‡§æ‡§Æ ‡§ï‡•ã ‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ
‚Ä¢ **‡§∏‡§æ‡§¨‡•Å‡§® ‡§™‡§æ‡§®‡•Ä**: 5ml liquid soap/‡§≤‡•Ä‡§ü‡§∞, ‡§∞‡•ã‡§ú‡§º‡§æ‡§®‡§æ
‚Ä¢ **‡§≤‡§π‡§∏‡•Å‡§® ‡§∏‡•ç‡§™‡•ç‡§∞‡•á**: 50g ‡§≤‡§π‡§∏‡•Å‡§® + 10 ‡§Æ‡§ø‡§∞‡•ç‡§ö/‡§≤‡•Ä‡§ü‡§∞ ‡§™‡§æ‡§®‡•Ä

### ‡§∞‡§æ‡§∏‡§æ‡§Ø‡§®‡§ø‡§ï ‡§â‡§™‡§ö‡§æ‡§∞ (Chemical Treatment):
‚Ä¢ **[Brand Name]**: [Active ingredient] - [exact dosage]/‡§è‡§ï‡§°‡§º
‚Ä¢ **[Brand Name]**: [Active ingredient] - [exact dosage]/‡§è‡§ï‡§°‡§º
‚Ä¢ ‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ ‡§∏‡§Æ‡§Ø: ‡§∂‡§æ‡§Æ 4-6 ‡§¨‡§ú‡•á, 7-10 ‡§¶‡§ø‡§® ‡§ï‡§æ ‡§Ö‡§Ç‡§§‡§∞

## üíä ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä (Shopping List):
‚Ä¢ **‡§®‡•Ä‡§Æ ‡§§‡•á‡§≤**: ‚Çπ250-350/‡§≤‡•Ä‡§ü‡§∞ (‡§ï‡•É‡§∑‡§ø ‡§¶‡•Å‡§ï‡§æ‡§®)
‚Ä¢ **[Chemical 1]**: ‚Çπ[price]/[size] - [company name]
‚Ä¢ **[Chemical 2]**: ‚Çπ[price]/[size] - [company name]

## üìÖ 7-‡§¶‡§ø‡§® ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§Ø‡•ã‡§ú‡§®‡§æ:
**Day 1-2**: ‡§™‡§π‡§≤‡§æ ‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ + ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ area ‡§ï‡•Ä ‡§∏‡§´‡§æ‡§à
**Day 3-4**: monitoring ‡§î‡§∞ ‡§¶‡•Ç‡§∏‡§∞‡§æ ‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ (‡§Ø‡§¶‡§ø ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•ã)
**Day 5-7**: ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö + ‡§§‡•Ä‡§∏‡§∞‡§æ ‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ

## ‚ö†Ô∏è ‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡§ø‡§Ø‡§æ‡§Ç:
‚Ä¢ ‡§Æ‡§æ‡§∏‡•ç‡§ï ‡§µ ‡§¶‡§∏‡•ç‡§§‡§æ‡§®‡•á ‡§ú‡§∞‡•Ç‡§∞ ‡§™‡§π‡§®‡•á‡§Ç
‚Ä¢ ‡§¨‡§æ‡§∞‡§ø‡§∂ ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ ‡§® ‡§ï‡§∞‡•á‡§Ç
‚Ä¢ ‡§∏‡•Å‡§¨‡§π 10 ‡§¨‡§ú‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ ‡§® ‡§ï‡§∞‡•á‡§Ç

‡§ï‡•É‡§™‡§Ø‡§æ specific Indian brand names, exact dosages, ‡§î‡§∞ practical advice ‡§¶‡•á‡§Ç ‡§ú‡•ã farmer ‡§§‡•Å‡§∞‡§Ç‡§§ implement ‡§ï‡§∞ ‡§∏‡§ï‡•á‡•§
"""

        # Get AI analysis
        ai_summary, _ = await chat_with_gpt(summary_prompt, user_id)
        
        # Create comprehensive follow-up message
        summary_message = f"""üìû **‡§Ü‡§™‡§ï‡•Ä Voice Call ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§®**

‚è±Ô∏è **‡§ï‡•â‡§≤ ‡§Ö‡§µ‡§ß‡§ø**: {call_duration//60} ‡§Æ‡§ø‡§®‡§ü {call_duration%60} ‡§∏‡•á‡§ï‡§Ç‡§°
üí¨ **‡§¨‡§æ‡§§‡§ö‡•Ä‡§§**: {len(user_messages)} ‡§∏‡§µ‡§æ‡§≤, {len(bot_messages)} ‡§ú‡§µ‡§æ‡§¨

{ai_summary}

üì± **‡§Ö‡§ó‡§≤‡•á ‡§ï‡§¶‡§Æ (Next Steps)**:
‚Ä¢ ‡§á‡§∏ solution ‡§ï‡•ã screenshot ‡§ï‡§∞ ‡§ï‡•á save ‡§ï‡§∞‡•á‡§Ç
‚Ä¢ ‡§¶‡§µ‡§æ‡§à ‡§ñ‡§∞‡•Ä‡§¶‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§¶‡•Å‡§ï‡§æ‡§®‡§¶‡§æ‡§∞ ‡§ï‡•ã ‡§Ø‡§π message ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
‚Ä¢ 'progress' ‡§≤‡§ø‡§ñ‡§ï‡§∞ treatment ‡§ï‡§æ ‡§π‡§æ‡§≤ ‡§¨‡§§‡§æ‡§è‡§Ç
‚Ä¢ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•ã ‡§§‡•ã 'help' ‡§Ø‡§æ 'call ‡§ï‡§∞‡•á‡§Ç' ‡§≤‡§ø‡§ñ‡•á‡§Ç

üìû **24x7 Support**: +91 85188 00080
üîÑ **Follow-up**: 3 ‡§¶‡§ø‡§® ‡§¨‡§æ‡§¶ update ‡§ú‡§∞‡•Ç‡§∞ ‡§ï‡§∞‡•á‡§Ç

‚úÖ **‡§Ø‡§π solution ‡§Ü‡§™‡§ï‡•Ä voice conversation ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ AI expert ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à**
"""

        # Send the comprehensive summary in chunks
        summary_chunks = format_whatsapp_message(summary_message, max_length=1500)
        
        for i, chunk in enumerate(summary_chunks):
            if len(summary_chunks) > 1:
                chunk_with_indicator = f"üìã Voice Call Report ({i+1}/{len(summary_chunks)})\n{chunk}"
            else:
                chunk_with_indicator = f"üìã Voice Call Complete Report\n{chunk}"
                
            send_whatsapp_message(phone_number, chunk_with_indicator)
            
            # Save each chunk to database
            save_message(user_id, chunk, "", True, "voice_call_summary")
        
        print(f"[POST_CALL] Comprehensive summary sent to {phone_number}, duration: {call_duration}s, messages: {len(user_messages)}")
        return True
        
    except Exception as e:
        print(f"[POST_CALL] Error sending summary to {phone_number}: {str(e)}")
        
        # Send basic completion message if AI analysis fails
        fallback_msg = f"""üìû **Voice Call ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§!**

‚è±Ô∏è **‡§ï‡•â‡§≤ ‡§Ö‡§µ‡§ß‡§ø**: {call_duration//60 if 'call_duration' in locals() else 0} ‡§Æ‡§ø‡§®‡§ü
‚úÖ ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡§ì‡§Ç ‡§™‡§∞ detailed ‡§ö‡§∞‡•ç‡§ö‡§æ ‡§π‡•Å‡§à

üîÑ **‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§ï‡§∞‡•á‡§Ç**:
‚Ä¢ ‡§Ö‡§™‡§®‡•Ä ‡§´‡§∏‡§≤ ‡§ï‡•Ä latest photo ‡§≠‡•á‡§ú‡•á‡§Ç analysis ‡§ï‡•á ‡§≤‡§ø‡§è
‚Ä¢ '‡§â‡§™‡§ö‡§æ‡§∞' ‡§≤‡§ø‡§ñ‡•á‡§Ç step-by-step treatment ‡§ï‡•á ‡§≤‡§ø‡§è
‚Ä¢ '‡§¶‡§µ‡§æ' ‡§≤‡§ø‡§ñ‡•á‡§Ç medicine ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è
‚Ä¢ Urgent help ‡§ï‡•á ‡§≤‡§ø‡§è 'call ‡§ï‡§∞‡•á‡§Ç' ‡§≤‡§ø‡§ñ‡•á‡§Ç

üìû **Direct Expert Help**: +91 85188 00080
üíö **‡§π‡§Æ‡•á‡§∂‡§æ ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§Æ‡•á‡§Ç - KHETI AI Team**"""

        send_whatsapp_message(phone_number, fallback_msg)
        save_message(user_id, fallback_msg, "", True, "voice_call_complete")
        return False

@router.post("/webhook")
async def webhook(req: Request):
    """Enhanced WhatsApp webhook with session management and proper message saving"""
    try:
        # Parse form data
        form = await req.form()
        
        # Extract information
        body_field = form.get("Body", "")
        if isinstance(body_field, str):
            message = body_field.strip()
        else:
            message = ""
        from_field = form.get("From", "")
        if not isinstance(from_field, str):
            from_field = str(from_field)
        phone_number = extract_phone_number(from_field)
        media_url = form.get("MediaUrl0")
        
        if not phone_number:
            return {"status": "error", "message": "No phone number provided"}

        # Use phone number as user_id for WhatsApp users
        user_id = phone_number
        
        # ---------------- TEXT MESSAGE HANDLING WITH SESSION MANAGEMENT ----------------
        if message and not media_url:
            # Save user with phone number
            save_user(user_id, phone_number, "")

            # Check if user is responding to voice bot question and handle API call
            voice_bot_handled = await handle_voice_bot_call(user_id, phone_number, "", message)
            if voice_bot_handled:
                return {"status": "success"}

            # Check if user is directly requesting a call (NEW FEATURE)
            if check_direct_call_request(message):
                # Save user request
                save_message(user_id, message, "", False, "")
                
                # Trigger immediate voice call without confirmation
                call_triggered = await initiate_direct_voice_call(user_id, phone_number, message)
                if call_triggered:
                    return {"status": "success", "action": "direct_call_initiated"}

            # Check if user is requesting progress update (NEW FEATURE)
            if message.lower().strip() in ['progress', '‡§™‡•ç‡§∞‡•ã‡§ó‡•ç‡§∞‡•á‡§∏', '‡§∏‡•ç‡§ü‡•á‡§ü‡§∏', 'status', 'update', '‡§π‡§æ‡§≤']:
                # Get recent call summaries and provide progress tracking
                progress_message = await get_treatment_progress(user_id, phone_number)
                send_whatsapp_message(phone_number, progress_message)
                save_message(user_id, progress_message, "", True, "progress_update")
                return {"status": "success", "action": "progress_update"}

            # Check if this is a follow-up message (treatment/prevention/medicine)
            should_handle_followup, detected_intent = follow_up_handler.should_handle_message(user_id, message)
            
            if should_handle_followup and detected_intent:
                # Get context from recent analysis
                analysis_info = follow_up_handler.get_last_analysis_info(user_id)
                
                # Generate targeted response
                follow_up_response = follow_up_handler.generate_response(
                    intent=detected_intent,
                    crop_type=analysis_info.get("crop_type", ""),
                    disease=analysis_info.get("disease", ""),
                    user_id=user_id
                )
                
                # Save user message
                save_message(user_id, message, "", False, analysis_info.get("crop_type", ""))
                
                # Send follow-up response in chunks if needed
                response_chunks = format_whatsapp_message(follow_up_response, max_length=1500)
                
                for i, chunk in enumerate(response_chunks):
                    # Save bot response
                    save_message(user_id, chunk, "", True, analysis_info.get("crop_type", ""))
                    
                    # Add chunk indicator for multi-part messages
                    if len(response_chunks) > 1:
                        chunk_with_indicator = f"({i+1}/{len(response_chunks)})\n{chunk}"
                    else:
                        chunk_with_indicator = chunk
                    
                    send_whatsapp_message(phone_number, chunk_with_indicator)
                
                return {"status": "success", "type": "follow_up", "intent": detected_intent}

            # Get AI response with crop type (includes session management)
            reply, crop_type = await chat_with_gpt(message, user_id)

            # Save user message to database
            save_message(user_id, message, "", False, crop_type)

            # Format and send response in properly sized chunks
            message_chunks = format_whatsapp_message(reply, max_length=1500)
            
            for i, chunk in enumerate(message_chunks):
                # Save each bot reply chunk to database
                save_message(user_id, chunk, "", True, crop_type)
                
                # Add message number indicator for multi-part messages
                if len(message_chunks) > 1:
                    chunk_indicator = f"({i+1}/{len(message_chunks)})\n{chunk}"
                else:
                    chunk_indicator = chunk
                    
                send_whatsapp_message(phone_number, chunk_indicator)

            # Send session info to user if it's a long conversation
            session_info = get_user_session_info(user_id)
            if session_info and session_info.get("message_count", 0) > 20:
                session_msg = f"üí¨ Session: {session_info.get('message_count', 0)} messages, {session_info.get('time_remaining', 0)//60:.0f} min remaining"
                send_whatsapp_message(phone_number, session_msg)
            
            # Occasionally suggest voice call feature for complex problems
            elif session_info and session_info.get("message_count", 0) > 5 and session_info.get("message_count", 0) % 7 == 0:
                call_hint_msg = (
                    "üí° **Quick Tip**: ‡§ú‡§ü‡§ø‡§≤ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡§ì‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è\n"
                    "üìû 'call ‡§ï‡§∞‡•á‡§Ç' ‡§≤‡§ø‡§ñ‡§ï‡§∞ Voice Expert ‡§∏‡•á ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç!\n"
                    "üéôÔ∏è ‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§® + WhatsApp follow-up"
                )
                send_whatsapp_message(phone_number, call_hint_msg)

        # ---------------- IMAGE MESSAGE HANDLING WITH SESSION MANAGEMENT ----------------
        elif media_url:
            try:
                # Save user with phone number
                save_user(user_id, phone_number, "")

                # Send acknowledgment
                ack_message = "üì∏ ‡§´‡•ã‡§ü‡•ã ‡§Æ‡§ø‡§≤ ‡§ó‡§à! ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§® ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...\n(Image received! Analyzing...)"
                send_whatsapp_message(phone_number, ack_message)
                
                # Save acknowledgment message to database
                save_message(user_id, ack_message, "", True, "")

                # Download image with improved authentication
                try:
                    if not isinstance(media_url, str):
                        media_url_str = str(media_url)
                    else:
                        media_url_str = media_url
                    image_content = download_twilio_media(media_url_str)
                    print(f"Successfully downloaded image for {phone_number}, size: {len(image_content)} bytes")
                except Exception as download_error:
                    print(f"Image download error for {phone_number}: {str(download_error)}")
                    raise download_error

                # Convert to base64
                image_base64 = base64.b64encode(image_content).decode('utf-8')
                print(f"Image converted to base64 for {phone_number}, length: {len(image_base64)}")

                # Analyze image with context and session management
                diagnosis, crop_type = await analyze_crop_image(image_base64, user_id)
                
                # Save image upload to database (store base64 instead of message text)
                save_message(user_id, "", image_base64, False, crop_type)
                
                # Format and send diagnosis in proper chunks
                diagnosis_chunks = format_whatsapp_message(diagnosis, max_length=1500)
                
                for i, chunk in enumerate(diagnosis_chunks):
                    # Save each diagnosis chunk to database
                    save_message(user_id, chunk, "", True, crop_type)
                    
                    if len(diagnosis_chunks) > 1:
                        chunk_with_indicator = f"üìã Report ({i+1}/{len(diagnosis_chunks)})\n{chunk}"
                    else:
                        chunk_with_indicator = f"üìã Fasal Analysis Report:\n{chunk}"
                        
                    send_whatsapp_message(phone_number, chunk_with_indicator)

                # Send follow-up options
                follow_up_msg = (
                    "üåü **‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§® ‡§Æ‡§ø‡§≤ ‡§ó‡§Ø‡§æ ‡§π‡•à!** "

                    "\nüéØ **‡§î‡§∞ ‡§≠‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è? ‡§Ø‡§π‡§æ‡§Å ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç:**"

                    "\nüíä **‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§â‡§™‡§ö‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è** (For detailed treatment):"
                    "\n‚Ä¢ '‡§â‡§™‡§ö‡§æ‡§∞' ‡§Ø‡§æ 'treatment'"
                    "\n‚Ä¢ '‡§á‡§≤‡§æ‡§ú' ‡§Ø‡§æ 'detailed solution'"

                    "\nüõ°Ô∏è **‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‡§¨‡§ö‡§æ‡§µ ‡§ï‡•á ‡§≤‡§ø‡§è** (For future prevention):"
                    "\n‚Ä¢ '‡§∞‡•ã‡§ï‡§•‡§æ‡§Æ' ‡§Ø‡§æ 'prevention'"
                    "\n‚Ä¢ '‡§¨‡§ö‡§æ‡§µ' ‡§Ø‡§æ 'protection'"

                    "\nüß™ **‡§¶‡§µ‡§æ ‡§ï‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è** (For complete medicine information):"
                    "\n‚Ä¢ '‡§¶‡§µ‡§æ' ‡§Ø‡§æ 'medicine'"
                    "\n‚Ä¢ '‡§ï‡•Ä‡§ü‡§®‡§æ‡§∂‡§ï' ‡§Ø‡§æ 'pesticide'"

                    "\nüßÆ **‡§ñ‡•Å‡§∞‡§æ‡§ï ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è** (For dosage calculator):"
                    "\n‚Ä¢ '‡§ñ‡•Å‡§∞‡§æ‡§ï' ‡§Ø‡§æ 'dosage'"
                    "\n‚Ä¢ '‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ' ‡§Ø‡§æ 'quantity'"

                    "\nüí∞ **‡§≤‡§æ‡§ó‡§§ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è** (For cost information):"
                    "\n‚Ä¢ '‡§ï‡•Ä‡§Æ‡§§' ‡§Ø‡§æ 'cost'"
                    "\n‚Ä¢ '‡§≤‡§æ‡§ó‡§§' ‡§Ø‡§æ 'budget'"

                    "\nüåæ **‡§´‡§∏‡§≤ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§ï‡•á ‡§≤‡§ø‡§è** (For crop management):"
                    "\n‚Ä¢ '‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®' ‡§Ø‡§æ 'management'"
                    "\n‚Ä¢ '‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤' ‡§Ø‡§æ 'care'"

                    "\n‚è∞ **‡§∏‡§Æ‡§Ø ‡§∏‡§æ‡§∞‡§£‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è** (For schedule):"
                    "\n‚Ä¢ '‡§∏‡§Æ‡§Ø' ‡§Ø‡§æ 'timing'"
                    "\n‚Ä¢ '‡§ï‡•à‡§≤‡•á‡§Ç‡§°‡§∞' ‡§Ø‡§æ 'calendar'"

                    "\nüÜò **‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è** (For emergency):"
                    "\n‚Ä¢ '‡§§‡•Å‡§∞‡§Ç‡§§' ‡§Ø‡§æ 'urgent'"
                    "\n‚Ä¢ '‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤' ‡§Ø‡§æ 'emergency'"

                    "\nüìû **‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§∏‡§≤‡§æ‡§π:** +91 85188 00080"

                    "\n‚ú® **‡§¨‡§∏ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Ç‡§∞‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡§æ‡§è‡§Ç!** (Just type and get complete information!)"
                )
                send_whatsapp_message(phone_number, follow_up_msg)
                
                # Save follow-up message to database
                save_message(user_id, follow_up_msg, "", True, crop_type)

                # Let's ask the farmer for the Voice-Bot assistance
                voice_bot_msg = (
                    "\nüéôÔ∏è‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ KHETI AI EXPERT ‡§∏‡•á ‡§¨‡§æ‡§§ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡•á‡§Ç‡§ó‡•á?\n"
                    "‡§Ö‡§™‡§®‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§¨‡§§‡§æ‡§è‡§Ç, ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡•Ç‡§Ç‡§ó‡§æ!"
                )
                send_whatsapp_message(phone_number, voice_bot_msg)
                save_message(user_id, voice_bot_msg, "", True, crop_type)

            except Exception as e:
                error_msg = f"‚ùå Photo processing mein problem: {str(e)[:100]}..."
                print(f"Image processing error for {phone_number}: {str(e)}")
                send_whatsapp_message(phone_number, error_msg)
                
                # Save error message to database
                save_message(user_id, error_msg, "", True, "")

        # If neither text nor image
        else:
            help_msg = (
                "üåæ *Krishi Sahayak Bot*\n\n"
                "Main aapki fasal ki problem mein madad kar sakta hun:\n"
                "üì∏ Fasal ki photo bhejiye\n"
                "üí¨ Apni problem likhiye\n"
                "üìç Apna location bataiye\n\n"
                "*Agri Help Bot*\n"
                "I can help with crop problems:\n"
                "üì∏ Send crop photos\n"
                "üí¨ Describe your problem\n"
                "üìç Share your location"
            )
            send_whatsapp_message(phone_number, help_msg)
            
            # Save help message to database
            save_user(user_id, phone_number, "")
            save_message(user_id, help_msg, "", True, "")

        return {"status": "success"}
    
    except Exception as e:
        print(f"Webhook error: {str(e)}")
        return {"status": "error", "message": str(e)}


@router.post("/test-direct-call")
async def test_direct_call_feature(phone_number: str, test_message: str = "call ‡§ï‡§∞‡•á‡§Ç"):
    """
    Test endpoint for the new direct call feature.
    """
    try:
        # Clean phone number
        clean_phone = phone_number.replace('+', '')
        if clean_phone.startswith('91'):
            clean_phone = clean_phone[2:]
        
        user_id = clean_phone
        
        # Test direct call detection
        is_direct_call = check_direct_call_request(test_message)
        
        if is_direct_call:
            # Simulate the direct call process
            call_result = await initiate_direct_voice_call(user_id, phone_number, test_message)
            
            return {
                "status": "success",
                "message": f"Direct call feature test completed",
                "phone_number": phone_number,
                "test_message": test_message,
                "detected_as_call_request": True,
                "call_initiated": call_result,
                "feature_working": True
            }
        else:
            return {
                "status": "success", 
                "message": "Message not detected as call request",
                "phone_number": phone_number,
                "test_message": test_message,
                "detected_as_call_request": False,
                "suggestion": "Try messages like: 'call ‡§ï‡§∞‡•á‡§Ç', 'call me', '‡§´‡•ã‡§® ‡§ï‡§∞‡•ã', '‡§¨‡§æ‡§§ ‡§ï‡§∞‡§®‡§æ ‡§π‡•à'"
            }
            
    except Exception as e:
        return {
            "status": "error",
            "error": str(e),
            "phone_number": phone_number,
            "test_message": test_message
        }


@router.get("/call-patterns")
async def get_call_patterns():
    """
    Get all supported patterns for direct call requests.
    """
    return {
        "direct_call_feature": {
            "description": "Users can now request calls directly without waiting for bot prompts",
            "supported_patterns": {
                "english": [
                    "call me", "call kar", "call karo", "call please", 
                    "phone call", "voice call", "baat karna chahiye", 
                    "call back", "ring me", "phone karo", "call now"
                ],
                "hindi": [
                    "‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç", "‡§ï‡•â‡§≤ ‡§ï‡§∞", "‡§ï‡•â‡§≤ ‡§ï‡§∞‡•ã", "‡§´‡•ã‡§® ‡§ï‡§∞‡•á‡§Ç", 
                    "‡§´‡•ã‡§® ‡§ï‡§∞‡•ã", "‡§¨‡§æ‡§§ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è", "‡§¨‡§æ‡§§ ‡§ï‡§∞‡§®‡§æ ‡§π‡•à",
                    "‡§Ü‡§µ‡§æ‡§ú‡§º ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§§", "voice ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§§", "‡§¨‡•ã‡§≤ ‡§ï‡§∞ ‡§¨‡§§‡§æ‡§è‡§Ç",
                    "‡§ï‡•â‡§≤ ‡§™‡§∞ ‡§¨‡§æ‡§§", "‡§´‡•ã‡§® ‡§™‡§∞ ‡§¨‡§æ‡§§", "call ‡§ï‡§∞‡•á‡§Ç", "call ‡§ï‡§∞‡•ã"
                ]
            },
            "how_it_works": [
                "1. User types any call request phrase",
                "2. System immediately detects intent", 
                "3. Sends acknowledgment message",
                "4. Initiates voice call within 30 seconds",
                "5. Enhanced system message with conversation context",
                "6. Post-call AI analysis and WhatsApp follow-up"
            ],
            "test_endpoint": "/test-direct-call?phone_number=+91XXXXXXXXXX&test_message=call ‡§ï‡§∞‡•á‡§Ç"
        }
    }

@router.post("/test-post-call-summary")
async def test_post_call_summary(phone_number: str):
    """
    Test the comprehensive post-call summary system with sample data.
    """
    try:
        # Clean phone number
        clean_phone = phone_number.replace('+', '')
        if clean_phone.startswith('91'):
            clean_phone = clean_phone[2:]
        
        # Sample transcript data (realistic conversation)
        sample_transcript = {
            "dialer_id": "0",
            "did_no": phone_number,
            "client_no": "416102",
            "customer_attended": "1", 
            "call_time": "2025-10-12T15:30:00+05:30",
            "call_conversation": [
                {"role": "user", "content": "‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§Æ‡•á‡§∞‡•Ä ‡§Æ‡§ø‡§∞‡•ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•à"},
                {"role": "assistant", "content": "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§ï‡•É‡§∑‡§ø ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§π‡•Ç‡§Å‡•§ ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§ø‡§∞‡•ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•à?"},
                {"role": "user", "content": "‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§™‡§∞ ‡§∏‡§´‡•á‡§¶ ‡§ú‡§æ‡§≤‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç ‡§™‡•Ä‡§≤‡•Ä ‡§π‡•ã‡§ï‡§∞ ‡§∏‡•Ç‡§ñ ‡§∞‡§π‡•Ä ‡§π‡•à‡§Ç‡•§ 5 ‡§è‡§ï‡§°‡§º ‡§Æ‡•á‡§Ç ‡§≤‡§ó‡•Ä ‡§π‡•à‡•§"},
                {"role": "assistant", "content": "‡§Ø‡§π ‡§∏‡•ç‡§™‡§æ‡§á‡§°‡§∞ ‡§Æ‡§æ‡§á‡§ü‡•ç‡§∏ ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§≤‡§ó‡§§‡•Ä ‡§π‡•à‡•§ ‡§ï‡§¨ ‡§∏‡•á ‡§Ø‡§π ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•à?"},
                {"role": "user", "content": "15-20 ‡§¶‡§ø‡§® ‡§∏‡•á ‡§π‡•à‡•§ ‡§™‡§π‡§≤‡•á ‡§•‡•ã‡§°‡§º‡•Ä ‡§•‡•Ä ‡§Ö‡§¨ ‡§¨‡§π‡•Å‡§§ ‡§¨‡§¢‡§º ‡§ó‡§à ‡§π‡•à‡•§"},
                {"role": "assistant", "content": "‡§Ü‡§™‡§®‡•á ‡§ï‡•ã‡§à ‡§¶‡§µ‡§æ ‡§°‡§æ‡§≤‡•Ä ‡§π‡•à ‡§Ö‡§¨ ‡§§‡§ï?"},
                {"role": "user", "content": "‡§π‡§æ‡§Å, Abamectin ‡§°‡§æ‡§≤‡•Ä ‡§•‡•Ä 1 ‡§π‡§´‡•ç‡§§‡•á ‡§™‡§π‡§≤‡•á ‡§≤‡•á‡§ï‡§ø‡§® ‡§ï‡•ã‡§à ‡§´‡§æ‡§Ø‡§¶‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü‡•§"},
                {"role": "assistant", "content": "Abamectin ‡§Ö‡§¨ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§Ü‡§™‡§ï‡•ã Spiromesifen ‡§Ø‡§æ Propargite ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§ ‡§∏‡§æ‡§• ‡§Æ‡•á‡§Ç ‡§®‡•Ä‡§Æ ‡§§‡•á‡§≤ ‡§≠‡•Ä ‡§Æ‡§ø‡§≤‡§æ‡§è‡§Ç‡•§"},
                {"role": "user", "content": "‡§ï‡§ø‡§§‡§®‡•Ä ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡§®‡§æ ‡§π‡•à ‡§î‡§∞ ‡§ï‡§π‡§æ‡§Å ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ?"},
                {"role": "assistant", "content": "Spiromesifen 1ml ‡§™‡•ç‡§∞‡§§‡§ø ‡§≤‡•Ä‡§ü‡§∞ ‡§™‡§æ‡§®‡•Ä ‡§Æ‡•á‡§Ç‡•§ ‡§ï‡•É‡§∑‡§ø ‡§¶‡•Å‡§ï‡§æ‡§® ‡§∏‡•á ‡§Æ‡§ø‡§≤ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§ ‡§∂‡§æ‡§Æ ‡§ï‡•ã ‡§õ‡§ø‡§°‡§º‡§ï‡§æ‡§µ ‡§ï‡§∞‡•á‡§Ç‡•§"}
            ],
            "recording_url": "https://calls2.ivrsolutions.in/monitor/sample.wav",
            "call_duration": "240",
            "recordid": "TEST123"
        }
        
        # Test the comprehensive summary system
        result = await send_post_call_summary(clean_phone, phone_number, sample_transcript)
        
        return {
            "status": "success",
            "message": "Post-call summary test completed",
            "phone_number": phone_number,
            "user_id": clean_phone,
            "summary_sent": result,
            "sample_conversation_length": len(sample_transcript['call_conversation']),
            "call_duration": sample_transcript['call_duration'] + " seconds",
            "features_tested": [
                "AI conversation analysis",
                "Problem identification", 
                "Organic + Chemical solutions",
                "Product recommendations with brands",
                "Shopping list with prices",
                "7-day treatment plan",
                "Safety warnings",
                "WhatsApp message chunking",
                "Database saving",
                "Progress tracking setup"
            ]
        }
        
    except Exception as e:
        return {
            "status": "error",
            "error": str(e),
            "phone_number": phone_number
        }

@router.get("/test-voice-bot/{phone_number}")
async def test_voice_bot_endpoint(phone_number: str):
    """Test endpoint to directly test voice bot API"""
    result = await test_voice_bot_api(phone_number)
    return {"success": result, "phone": phone_number}